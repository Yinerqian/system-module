<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.celi.system.message.dao.MsgSendLogDao">
    <insert id="insertMsgSendLog">
        insert into msg_send_log(request_id, message_body, send_response, send_status, channel_code, template_code, topic_code, remark
        , tenant_id, create_date, create_by, update_date, update_by, del_flag)
        values (#{requestId}, #{messageBody}, #{sendResponse}, #{sendStatus}, #{channelCode}, #{templateCode}, #{topicCode}, #{remark}
        , #{tenantId}, #{createDate}, #{createBy}, #{updateDate}, #{updateBy}, #{delFlag})
    </insert>

    <update id="deleteMsgSendLog">
        update msg_send_log
        set del_flag = 1
            update_date = #{updateDate},
            update_by = #{updateBy}
        where request_id = #{requestId}
    </update>

    <update id="updateMsgSendLog">
        update msg_send_log
        set send_response = #{sendResponse},
            send_status = #{sendStatus},
            remark = #{remark},
            update_date = #{updateDate}
        where request_id = #{requestId}
    </update>

    <update id="updateMsgSendLogStatus">
        update msg_send_log
        set send_status = #{status},
            update_date = now()
        where request_id = #{requestId}
    </update>

    <select id="getMsgSendLogDetailById" resultType="com.celi.system.message.entity.MsgSendLog">
        select msl.*, mt.template_name, mc.channel_name, mtc.topic_name
        from msg_send_log msl
        left join msg_template mt on msl.template_code = mt.template_code and mt.tenant_id = #{tenantId} and mt.del_flag = 0
        left join msg_channel mc on msl.channel_code = mc.channel_code and mc.tenant_id = #{tenantId} and mc.del_flag = 0
        left join msg_topic mtc on msl.topic_code = mtc.topic_code and mtc.tenant_id = #{tenantId} and mtc.del_flag = 0
        where request_id = #{requestId}
    </select>

    <select id="getMsgSendLogById" resultType="com.celi.system.message.entity.MsgSendLog">
        select *
        from msg_send_log
        where request_id = #{requestId}
    </select>

    <select id="listMsgSendLog" resultType="com.celi.system.message.entity.MsgSendLog">
        select *
        from msg_send_log msl
        where tenant_id = #{filter.tenantId}
        and del_flag = 0
        <if test="filter.sendStatus != null">
            and send_status = #{filter.sendStatus}
        </if>
        <if test="filter.channelCode != null and filter.channelCode != ''">
            and channel_code = #{filter.channelCode}
        </if>
        <if test="filter.filterStartDate != null and filter.filterStartDate != ''">
            and date_format(create_date, '%Y-%m-%d') = #{filter.filterStartDate}
        </if>
    </select>

</mapper>
